{% extends 'base.html' %}

{% block title %}Helpdesk Dashboard{% endblock %}

{% block content %}
    <header class="mb-8">
        <h2 class="text-4xl font-bold text-slate-700 mb-2">Helpdesk Dashboard</h2>
        <p class="text-slate-600 text-lg">Bienvenido al sistema de soporte técnico. Envíe un ticket para obtener ayuda
            con sus problemas técnicos.</p>
    </header>
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-500">Tickets Abiertos</h3>
                <span class="material-icons text-slate-400">inbox</span>
            </div>
            <p class="text-5xl font-bold text-slate-700">{{ counts.open }}</p>
            <p class="text-sm text-slate-500 mt-1">Entradas en espera de asignación</p>
            {% if user.is_staff %}
                <a href="{% url 'manage_tickets' %}?status=open" class="btn btn-light btn-sm">Ver</a>
            {% endif %}
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-blue-500">Tickets En Proceso</h3>
                <span class="material-icons text-blue-400">hourglass_top</span>
            </div>
            <p class="text-5xl font-bold text-blue-700">{{ counts.in_process }}</p>
            <p class="text-sm text-blue-500 mt-1">Tickets en que se está trabajando</p>
            {% if user.is_staff %}
                <a href="{% url 'manage_tickets' %}?status=in_process" class="btn btn-light btn-sm">Ver</a>
            {% endif %}
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-green-500">Tickets Cerrados</h3>
                <span class="material-icons text-green-400">task_alt</span>
            </div>
            <p class="text-5xl font-bold text-green-700">{{ counts.closed }}</p>
            <p class="text-sm text-green-500 mt-1">Tickets que han sido resueltos</p>
            {% if user.is_staff %}
                <a href="{% url 'manage_tickets' %}?status=closed" class="btn btn-light btn-sm">Ver</a>
            {% endif %}
        </div>
        <div class="bg-slate-700 text-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Total Tickets</h3>
                <span class="material-icons text-slate-300">assessment</span>
            </div>
            <p class="text-5xl font-bold">{{ counts.total }}</p>
            <p class="text-sm text-slate-300 mt-1">Total tickets en el sistema</p>
            {% if user.is_staff %}
                <a href="{% url 'manage_tickets' %}" class="btn btn-light btn-sm">Ver</a>
            {% endif %}
        </div>
    </section>
    
    <!-- Average response time by ticket type (with guidelines in parentheses) -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold text-slate-600">Promedio Normal <span class="text-slate-400">(48 horas)</span></h3>
                <span class="material-icons text-slate-400">schedule</span>
            </div>
            <p class="text-3xl font-bold text-slate-800">{{ avg_by_priority.normal }}</p>
            <p class="text-sm text-slate-500 mt-1">Tiempo desde creación hasta cierre</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold text-amber-600">Promedio Prioritario <span class="text-amber-400">(24 horas)</span></h3>
                <span class="material-icons text-amber-400">schedule</span>
            </div>
            <p class="text-3xl font-bold text-amber-800">{{ avg_by_priority.priority }}</p>
            <p class="text-sm text-slate-500 mt-1">Tiempo desde creación hasta cierre</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold text-red-600">Promedio Urgente <span class="text-red-400">(8 horas)</span></h3>
                <span class="material-icons text-red-400">schedule</span>
            </div>
            <p class="text-3xl font-bold text-red-800">{{ avg_by_priority.urgent }}</p>
            <p class="text-sm text-slate-500 mt-1">Tiempo desde creación hasta cierre</p>
        </div>
    </section>

    <!-- Gráficas en filas de 2 tarjetas por fila -->
    <section class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 1) Creados vs Cerrados -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-slate-700">Tickets creados vs cerrados (último año)</h3>
            </div>
            <div class="relative h-64 md:h-80">
                <canvas id="chartCreatedClosed" style="width:100% !important;height:100% !important"></canvas>
            </div>
        </div>

        <!-- 2) Normal -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h4 class="text-md font-semibold text-slate-700 mb-3">Normal</h4>
            <div class="relative h-64 md:h-80">
                <canvas id="chartNormal" style="width:100% !important;height:100% !important"></canvas>
            </div>
        </div>

        <!-- 3) Prioritario -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h4 class="text-md font-semibold text-amber-700 mb-3">Prioritario</h4>
            <div class="relative h-64 md:h-80">
                <canvas id="chartPriority" style="width:100% !important;height:100% !important"></canvas>
            </div>
        </div>

        <!-- 4) Urgente -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h4 class="text-md font-semibold text-red-700 mb-3">Urgente</h4>
            <div class="relative h-64 md:h-80">
                <canvas id="chartUrgent" style="width:100% !important;height:100% !important"></canvas>
            </div>
        </div>

        <!-- 5) Promedio por mes (horas) -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-slate-700">Tiempo de respuesta promedio por mes (horas)</h3>
            </div>
            <div class="relative h-64 md:h-80">
                <canvas id="chartAvgResponse" style="width:100% !important;height:100% !important"></canvas>
            </div>
        </div>
    </section>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        (function() {
            const data = {{ charts_json|safe }};

            // Palette
            const COLORS = {
                created: '#0ea5e9', // sky-500
                closed: '#22c55e',  // green-500
                normal: '#3b82f6',  // blue-500
                priority: '#f59e0b',// amber-500
                urgent: '#ef4444',  // red-500
            };

            // Opciones globales para responsividad y buena visualización con cualquier cantidad de puntos
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false, // El alto lo controla el contenedor
                spanGaps: true,
                interaction: { mode: 'index', intersect: false },
                layout: { padding: { top: 8, right: 8, bottom: 8, left: 8 } },
                elements: {
                    line: { borderWidth: 2, tension: 0.25 },
                    point: { radius: 2, hitRadius: 6 }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#475569',
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 12
                        },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        grace: '10%',
                        ticks: { color: '#475569' }
                    }
                },
                plugins: {
                    legend: { position: 'top', labels: { color: '#334155' } },
                    tooltip: { mode: 'index', intersect: false }
                }
            };

            // Chart 1: Created vs Closed
            new Chart(document.getElementById('chartCreatedClosed').getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'Creados', data: data.created, borderColor: COLORS.created, backgroundColor: COLORS.created, fill: false },
                        { label: 'Cerrados', data: data.closed, borderColor: COLORS.closed, backgroundColor: COLORS.closed, fill: false },
                    ]
                },
                options: baseOptions
            });

            // Helper to make per-priority chart
            function makePriorityChart(canvasId, prKey, titleColor) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            { label: 'Creados', data: data.per_priority[prKey].created, borderColor: COLORS.created, backgroundColor: COLORS.created, fill: false },
                            { label: 'Cerrados', data: data.per_priority[prKey].closed, borderColor: COLORS.closed, backgroundColor: COLORS.closed, fill: false },
                        ]
                    },
                    options: baseOptions
                });
            }

            makePriorityChart('chartNormal', 'normal');
            makePriorityChart('chartPriority', 'priority');
            makePriorityChart('chartUrgent', 'urgent');

            // Avg response time chart (hours)
            new Chart(document.getElementById('chartAvgResponse').getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'Normal (h)', data: data.avg_hours_per_month.normal, borderColor: COLORS.normal, backgroundColor: COLORS.normal, fill: false },
                        { label: 'Prioritario (h)', data: data.avg_hours_per_month.priority, borderColor: COLORS.priority, backgroundColor: COLORS.priority, fill: false },
                        { label: 'Urgente (h)', data: data.avg_hours_per_month.urgent, borderColor: COLORS.urgent, backgroundColor: COLORS.urgent, fill: false },
                    ]
                },
                options: {
                    ...baseOptions,
                    scales: {
                        ...baseOptions.scales,
                        y: {
                            ...baseOptions.scales.y,
                            title: { display: true, text: 'Horas' }
                        }
                    }
                }
            });
        })();
    </script>
{% endblock %}
